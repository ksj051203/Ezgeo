<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
    <script
            src="https://code.jquery.com/jquery-3.6.3.js"
            integrity="sha256-nQLuAZGRRcILA+6dMBOvcRh5Pe310sBpanc6+QBmyVM="
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <title>게시글 상세보기</title>
    <style>
    </style>
</head>
<body>
    <h1 th:text="${board.board_title}"></h1>
    <p th:text="${board.board_writer}"></p>
    <p th:text="${board.board_content}"></p>
    <p th:text="${board.board_write_date}"></p>
    <p th:text="${board.board_modify_date}"></p>
    <a th:href="@{/delete(board_id=${board.board_id})}">삭제</a>
    <a th:href="@{/modify/{board_id}(board_id=${board.board_id})}">수정</a>

    <form id="frm" name="frm" th:action="@{/list/addComment/{board_id}(board_id=${board.board_id})}" method="post">
        <input type="text" name="comment_writer" value="작성자">
        <input type="text" name="comment_content" value="내용">
        <input type="text" name="comment_password" value="비밀번호">
        <input type="hidden" name="depth" value="0">
        <input type="hidden" name="board_id" th:value="${board.board_id}">
        <input type="hidden" name="parent_id" value="0">
        <button type="submit">작성</button>
    </form>


    <div th:each="comment, loop: ${comment}">
            <span th:text="${comment.content}"></span>
            <button th:id = "${comment.id}" class = "writeComment" type="submit" th:attr="data-depth=${comment.depth}">댓글 등록</button>
            <button th:id = "${comment.id}" class = "deleteComment" type="submit" th:attr="data-depthDele=${comment.depth}">댓글 삭제</button>
    </div>

<script>
        const writeComment = document.querySelectorAll('.writeComment');
        const writeCommentSize = writeComment.length;

        let path = location.pathname;
        console.log(path);
        let board_id = path.split('/')[2];


        for(let i = 0; i<writeCommentSize; i++){
            let comment = writeComment[i];
            comment.addEventListener("click", function(){
                let id = comment.id
                let depth = parseInt(comment.dataset.depth);

                const input1 = document.createElement("input");
                // 내용
                const input2 = document.createElement("input");

                const input3 = document.createElement("input");
                // 등록
                const button1 = document.createElement("button");
                // 삭제
                const button2 = document.createElement("button");


                input1.innerHTML = "작성자";
                input2.innerHTML = "내용";
                input3.innerHTML = "비밀번호"
                button1.innerHTML = "답글 작성";
                button2.innerHTML="취소";

                input1.setAttribute("id", "comment_writer");
                input2.setAttribute("id", "comment_content");
                input3.setAttribute("id", "comment_password");
                button1.setAttribute("id", "write");


                const divEl = document.createElement("div");

                divEl.appendChild(input1);
                divEl.appendChild(input2);
                divEl.appendChild(input3);
                divEl.appendChild(button1);
                divEl.appendChild(button2);

                document.body.appendChild(divEl);

                // button1이 눌러진다면 axios post로 data 보내기
                document.getElementById("write").addEventListener("click", async function(){

                    try{
                        let comment_writer = document.getElementById('comment_writer').value;
                        let comment_content = document.getElementById('comment_content').value;
                        let comment_password = document.getElementById("comment_password").value;

                        console.log(`depth:${depth}`)
                        await axios.post(`/list/addComment/axios/${board_id}`,
                            {

                                parent_id : id,
                                comment_writer : comment_writer,
                                comment_content : comment_content,
                                board_id : board_id,
                                depth : depth+1,
                                comment_password : comment_password,
                            },
                            {
                                "Content-Type" : `application/json`,
                            },
                        )
                    }

                    catch (e){
                        alert(e);
                    }
                })


            })

        }

        $(document).on("click",".deleteComment", async (e)=>{

            var password = prompt("비밀번호를 입력하세요", "");

            let idCheck = $(e.target).attr("id");

            // axios 처리
            const axiosConfig = {
                headers:{
                    "Content-Type": "application/json"
                }
            }

            const {data} = await axios.post("/delete/password", {idCheck, board_id, password}, axiosConfig);

            if (!data.rtn=='Y') {
                alert('삭제 실패');
                return;
            }

            alert('삭제 완료')
            location.reload();
        });



</script>
</body>
</html>